<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}';">
  <title>StructVisualizer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: #fff;
      color: #333;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      border-bottom: none;
      cursor: pointer;
      font-weight: bold;
    }
    .tab-btn.active {
      background: white;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
    }
    .tab-content {
      display: none;
      border: 1px solid #ccc;
      padding: 12px;
      flex: 1;
      overflow: auto;
    }
    .tab-content.active {
      display: flex;
      flex-direction: column;
    }
    button {
      padding: 6px 12px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #005a9e;
    }
    label {
      display: block;
      margin: 6px 0 4px;
      font-weight: bold;
    }
    input[type="number"] {
      width: 80px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    input[type="range"] {
      width: 120px;
      margin: 0 8px;
    }
    textarea {
      width: 100%;
      height: 100%;
      resize: none;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 8px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    .status {
      margin-top: 8px;
      font-family: monospace;
      font-size: 13px;
      color: #d00;
      min-height: 1.5em;
    }
    .visualizer-container {
      flex: 1;
      overflow: auto;
      background: white;
      border: 1px solid #ccc;
    }
    small {
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="code">Code</button>
      <button class="tab-btn" data-tab="visualizer">Visualizer</button>
      <button class="tab-btn" data-tab="types">Types</button>
    </div>

    <!-- Tab 1: Code -->
    <div class="tab-content active" id="code-tab">
      <textarea id="code-editor">struct Example {
    uint8_t flags;
    uint16_t count;
    void* handler;
};</textarea>
      <div>
        <button id="visualize-btn">Visualize</button>
        <button id="load-example-btn">Load Example</button>
        <button id="add-to-json-btn">üíæ Add Struct to JSON</button>
      </div>
    </div>

    <!-- Tab 2: Visualizer -->
    <div class="tab-content" id="visualizer-tab">
      <div>
        <label for="pack-input">Packing (bytes):</label>
        <input type="number" id="pack-input" value="4" min="0" placeholder="natural">
        <small>0 or empty = natural alignment</small>
      </div>
      <div>
        <label for="byte-width">Byte Width (px):</label>
        <input type="range" id="byte-width" min="40" max="200" value="60">
        <span id="byte-width-value">60 px</span>
      </div>
      <div class="status" id="status-bar"></div>
      <div class="visualizer-container">
        <div id="visualizer-canvas"></div>
      </div>
    </div>

    <!-- Tab 3: Types -->
    <div class="tab-content" id="types-tab">
      <table id="types-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Size (B)</th>
            <th>Align (B)</th>
          </tr>
        </thead>
        <tbody id="types-body">
          <!-- Filled by JS -->
        </tbody>
      </table>
      <div>
        <button id="types-add">Add</button>
        <button id="types-edit">Edit</button>
        <button id="types-delete">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>

<script nonce="${nonce}">
(function () {
    const vscode = acquireVsCodeApi();
    let currentTypes = {};
    let lastLayout = null;

    // TAB HANDLING
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        if (tabName === 'types') {
            vscode.postMessage({ command: 'loadTypes' });
        }
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchTab(btn.dataset.tab);
        });
    });

    // DOM ELEMENTS
    const codeEditor = document.getElementById('code-editor');
    const packInput = document.getElementById('pack-input');
    const byteWidthSlider = document.getElementById('byte-width');
    const byteWidthValue = document.getElementById('byte-width-value');
    const visualizeBtn = document.getElementById('visualize-btn');
    const loadExampleBtn = document.getElementById('load-example-btn');
    const addToJsonBtn = document.getElementById('add-to-json-btn');
    const typesAddBtn = document.getElementById('types-add');
    const typesEditBtn = document.getElementById('types-edit');
    const typesDeleteBtn = document.getElementById('types-delete');
    const visualizerCanvas = document.getElementById('visualizer-canvas');
    const statusBar = document.getElementById('status-bar');

    function setStatus(message, isError = false) {
        statusBar.textContent = message;
        statusBar.style.color = isError ? '#d00' : '#007acc';
    }

    function loadExample() {
        codeEditor.value = `struct DeviceConfig {
    uint8 enable    : 1;
    uint8 mode      : 3;
    uint8 priority  : 2;
    uint8 reserved  : 2;
    uint16 timeout  : 10;
    uint16 retries  : 6;
    uint32 data;
};`;
    }

    // MODAL DIALOGS
    function showConfirmDialog(message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;">
                <div style="background:white;padding:20px;border-radius:8px;max-width:400px;width:90%;">
                    <p>${message}</p>
                    <div>
                        <button id="confirm-yes" style="margin-right:10px;">Yes</button>
                        <button id="confirm-no">No</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById('confirm-no').onclick = () => {
            document.body.removeChild(overlay);
        };

        document.getElementById('confirm-yes').onclick = () => {
            document.body.removeChild(overlay);
            onConfirm();
        };
    }

    function showTypeDialog(title, typeName = '', size = 1, align = 1, isEdit = false) {
        const overlay = document.createElement('div');
        overlay.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;">
                <div style="background:white;padding:20px;border-radius:8px;max-width:400px;width:90%;">
                    <h3>${title}</h3>
                    <label>Type Name:</label>
                    <input type="text" id="dialog-name" value="${typeName}" ${isEdit ? 'readonly' : ''} style="width:100%;margin:5px 0;">
                    <label>Size (bytes):</label>
                    <input type="number" id="dialog-size" value="${size}" min="1" style="width:100%;margin:5px 0;">
                    <label>Alignment (bytes):</label>
                    <input type="number" id="dialog-align" value="${align}" min="1" style="width:100%;margin:5px 0;">
                    <div style="margin-top:10px;">
                        <button id="dialog-save">Save</button>
                        <button id="dialog-cancel">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById('dialog-cancel').onclick = () => {
            document.body.removeChild(overlay);
        };

        document.getElementById('dialog-save').onclick = () => {
            const name = document.getElementById('dialog-name').value.trim();
            const size = parseInt(document.getElementById('dialog-size').value);
            const align = parseInt(document.getElementById('dialog-align').value);
            document.body.removeChild(overlay);
            if (name && size > 0 && align > 0) {
                vscode.postMessage({
                    command: isEdit ? 'updateType' : 'addType',
                    typeName: name,
                    size,
                    align
                });
            }
        };
    }

    function showTypePrompt(typeName) {
        const overlay = document.createElement('div');
        overlay.innerHTML = `
            <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;">
                <div style="background:white;padding:20px;border-radius:8px;max-width:400px;width:90%;">
                    <h3>Define Type: <code>${typeName}</code></h3>
                    <p>Type not found in project.</p>
                    <label>Size (bytes):</label>
                    <input type="number" id="prompt-size" value="1" min="1" style="width:100%;margin:5px 0;">
                    <label>Alignment (bytes):</label>
                    <input type="number" id="prompt-align" value="1" min="1" style="width:100%;margin:5px 0;">
                    <div style="margin-top:10px;">
                        <button id="prompt-save" style="margin-right:10px;">Add Type</button>
                        <button id="prompt-cancel">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById('prompt-cancel').onclick = () => {
            document.body.removeChild(overlay);
            setStatus(`Type '${typeName}' not defined.`, true);
        };

        document.getElementById('prompt-save').onclick = () => {
            const size = document.getElementById('prompt-size').value;
            const align = document.getElementById('prompt-align').value;
            document.body.removeChild(overlay);
            vscode.postMessage({
                command: 'saveManualType',
                typeName,
                size: parseInt(size),
                align: parseInt(align)
            });
        };
    }

    // TYPES TABLE
    function renderTypes(types) {
        currentTypes = types;
        const tbody = document.getElementById('types-body');
        tbody.innerHTML = '';
        for (const [name, info] of Object.entries(types)) {
            const row = tbody.insertRow();
            row.dataset.type = name;
            row.innerHTML = `<td>${name}</td><td>${info.size}</td><td>${info.align}</td>`;
            row.addEventListener('click', () => {
                document.querySelectorAll('#types-body tr').forEach(r => r.style.backgroundColor = '');
                row.style.backgroundColor = '#e0e0e0';
            });
        }
    }

    // VISUALIZATION
    function renderLayout(layout, byteWidth = 60) {
        const canvas = visualizerCanvas;
        canvas.innerHTML = '';

        const scale = byteWidth;
        const rowBytes = layout.pack_value || layout.max_align;
        let html = '';

        const dataBytes = layout.fields.reduce((sum, f) => sum + f.size, 0);
        const padBytes = layout.total_size - dataBytes;
        const efficiency = layout.total_size ? ((dataBytes / layout.total_size) * 100).toFixed(1) : '0.0';
        const color = efficiency >= 70 ? 'black' : 'red';
        html += `<div style="font-family:monospace;font-weight:bold;color:${color};margin-bottom:8px;">
            Size: ${layout.total_size} B | Data: ${dataBytes} B | Pad: ${padBytes} B | Eff: ${efficiency}%
        </div>`;
        html += `<div style="font-family:monospace;font-weight:bold;margin-bottom:12px;">
            ${layout.pack_value ? `Packed: ${layout.pack_value} B` : `Natural (max align ${layout.max_align} B)`}
        </div>`;

        let byteOffset = 0;
        while (byteOffset < layout.total_size) {
            const start = byteOffset;
            const end = Math.min(byteOffset + rowBytes, layout.total_size);
            const rowWidth = (end - start) * scale;

            let maxBitFields = 0;
            for (const field of layout.fields) {
                const fStart = field.offset;
                const fEnd = fStart + field.size;
                if (fStart < end && fEnd > start && field.bit_fields) {
                    maxBitFields = Math.max(maxBitFields, field.bit_fields.length);
                }
            }
            const rowHeight = Math.max(50, 50 + Math.max(0, maxBitFields - 1) * 14);

            html += `<div style="position:relative;height:${rowHeight}px;border:2px solid black;width:${rowWidth}px;margin-bottom:10px;">`;

            for (let i = start; i < end; i++) {
                if (i < 1000) {
                    html += `<div style="position:absolute;top:-24px;left:${(i - start) * scale}px;width:${scale}px;text-align:center;font-family:monospace;font-size:10px;color:blue;">${i}</div>`;
                }
            }

            html += `<div style="position:absolute;left:-30px;top:${rowHeight/2 - 8}px;font-family:monospace;font-size:12px;color:darkblue;">${start.toString().padStart(2, ' ')}</div>`;

            const items = [];

            for (const field of layout.fields) {
                const padStart = field.offset - field.padding_before;
                const padEnd = field.offset;
                if (padStart < end && padEnd > start) {
                    const ps = Math.max(padStart, start);
                    const pe = Math.min(padEnd, end);
                    if (pe > ps) {
                        items.push({ type: 'pad', start: ps, end: pe });
                    }
                }
            }

            for (const field of layout.fields) {
                const fStart = field.offset;
                const fEnd = fStart + field.size;
                if (fStart < end && fEnd > start) {
                    const fs = Math.max(fStart, start);
                    const fe = Math.min(fEnd, end);
                    if (fe > fs) {
                        items.push({ type: 'field', start: fs, end: fe, field: field });
                    }
                }
            }

            items.sort((a, b) => a.start - b.start);

            for (const item of items) {
                const x = (item.start - start) * scale;
                const w = (item.end - item.start) * scale;
                if (item.type === 'pad') {
                    html += `<div style="position:absolute;left:${x}px;top:0;height:${rowHeight}px;width:${w}px;background:#ff4d4d;opacity:0.7;"></div>`;
                    if (w > 30) {
                        html += `<div style="position:absolute;left:${x + w/2}px;top:${rowHeight/2 - 8}px;transform:translateX(-50%);color:white;font-family:monospace;font-size:10px;font-weight:bold;">PAD</div>`;
                    }
                } else {
                    const field = item.field;
                    let color = 'lightgreen';
                    if (field.type === 'function_ptr') color = 'plum';
                    else if (field.is_pointer) color = 'lightblue';

                    html += `<div style="position:absolute;left:${x}px;top:0;height:${rowHeight}px;width:${w}px;background:${color};border:2px solid black;"></div>`;

                    let label = field.name;
                    if (field.type === 'function_ptr') label += '_fn';
                    else if (field.is_pointer) label += '*';
                    if (field.is_array && field.count > 1) label += `[${field.count}]`;

                    if (w > 40) {
                        html += `<div style="position:absolute;left:${x + w/2}px;top:12px;transform:translateX(-50%);font-family:monospace;font-size:11px;font-weight:bold;">${label}</div>`;
                    }

                    if (field.bit_fields && field.bit_fields.length > 0) {
                        if (field.bit_fields.length === 1) {
                            const bitLabel = `${field.bit_fields[0].name}:${field.bit_fields[0].bits}b`;
                            if (w > 30) {
                                html += `<div style="position:absolute;left:${x + w/2}px;top:28px;transform:translateX(-50%);font-family:monospace;font-size:9px;">${bitLabel}</div>`;
                            }
                        } else if (w > 40) {
                            const startY = 28;
                            field.bit_fields.forEach((bit, idx) => {
                                const bitLabel = `${bit.name}:${bit.bits}b`;
                                const yPos = startY + idx * 14;
                                if (yPos + 10 < rowHeight) {
                                    html += `<div style="position:absolute;left:${x + 4}px;top:${yPos}px;font-family:monospace;font-size:9px;">${bitLabel}</div>`;
                                }
                            });
                        }
                    }
                }
            }

            html += `</div>`;
            byteOffset += rowBytes;
        }

        canvas.innerHTML = html;
        setStatus('Visualization complete.', false);
    }

    // MESSAGE HANDLER
    window.addEventListener('message', event => {
        const message = event.data;
        if (message.command === 'preloadCode') {
            codeEditor.value = message.code;
            setTimeout(() => {
                switchTab('code');
            }, 50);
        } else if (message.command === 'pythonResult') {
            try {
                const layout = JSON.parse(message.output);
                if (layout.error) {
                    setStatus(layout.error, true);
                } else if (layout.unknown_type) {
                    showTypePrompt(layout.unknown_type);
                } else {
                    lastLayout = layout;
                    switchTab('visualizer');
                    renderLayout(layout, parseInt(byteWidthSlider.value));
                }
            } catch (e) {
                setStatus('Invalid Python output', true);
            }
        } else if (message.command === 'pythonError') {
            setStatus(`Python error: ${message.error}`, true);
        } else if (message.command === 'retryVisualization') {
            visualize(false);
        } else if (message.command === 'typesLoaded') {
            renderTypes(message.types);
        } else if (message.command === 'typeActionResult') {
            if (message.success) {
                vscode.postMessage({ command: 'loadTypes' });
            } else {
                setStatus('Action failed: ' + message.error, true);
            }
        }
    });

    // BUTTONS
    visualizeBtn.addEventListener('click', () => {
        const code = codeEditor.value;
        const packValue = packInput.value.trim();
        const packArg = packValue === '' || packValue === '0' ? '0' : packValue;
        vscode.postMessage({
            command: 'runPython',
            script: 'main_wrapper.py',
            args: [code, packArg, '0']
        });
    });

    loadExampleBtn.addEventListener('click', loadExample);

    addToJsonBtn.addEventListener('click', () => {
        const code = codeEditor.value;
        const packValue = packInput.value.trim();
        const packArg = packValue === '' || packValue === '0' ? '0' : packValue;
        vscode.postMessage({
            command: 'runPython',
            script: 'main_wrapper.py',
            args: [code, packArg, '1']
        });
    });

    typesAddBtn.addEventListener('click', () => {
        showTypeDialog('Add Type');
    });

    typesEditBtn.addEventListener('click', () => {
        const selected = document.querySelector('#types-body tr[style*="background"]');
        if (!selected) {
            setStatus('Select a type to edit.', true);
            return;
        }
        const name = selected.dataset.type;
        const info = currentTypes[name];
        showTypeDialog('Edit Type', name, info.size, info.align, true);
    });

    typesDeleteBtn.addEventListener('click', () => {
        const selected = document.querySelector('#types-body tr[style*="background"]');
        if (!selected) {
            setStatus('Select a type to delete.', true);
            return;
        }
        const name = selected.dataset.type;
        showConfirmDialog(`Delete type '${name}'?`, () => {
            vscode.postMessage({ command: 'deleteType', typeName: name });
        });
    });

    byteWidthSlider.addEventListener('input', () => {
        const value = byteWidthSlider.value;
        byteWidthValue.textContent = `${value} px`;
        if (lastLayout) {
            renderLayout(lastLayout, parseInt(value));
        }
    });

    // INIT
    vscode.postMessage({ command: 'loadTypes' });
    loadExample();
})();
</script>

</body>
</html>